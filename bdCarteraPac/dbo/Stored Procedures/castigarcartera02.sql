CREATE PROCEDURE castigarcartera02 AS

select * into #tmpCastigar
from tbestadoscuenta where nmro_estdo_cnta in
(1344406	,
1344419	,
1344419	,
1344616	,
1344700	,
1344700	,
1344700	,
1344700	,
1344714	,
1344759	,
1344763	,
1345118	,
1345200	,
1345735	,
1347061	,
1347201	,
1347398	,
1347472	,
1347490	,
1347648	,
1347881	,
1348221	,
1348357	,
1348981	,
1349061	,
1349719	,
1349817	,
1349817	,
1349897	,
1349980	,
1350001	,
1350034	,
1350095	,
1350108	,
1350128	,
1350156	,
1350186	,
1350186	,
1350446	,
1350516	,
1350806	,
1350819	,
1351133	,
1351180	,
1351259	,
1351268	,
1351753	,
1352202	,
1352224	,
1352463	,
1352597	,
1352753	,
1352789	,
1352862	,
1352880	,
1353039	,
1353083	,
1353083	,
1353104	,
1353133	,
1353279	,
1353337	,
1353395	,
1353450	,
1353475	,
1353902	,
1353992	,
1353997	,
1354192	,
1354356	,
1354370	,
1354425	,
1354445	,
1354454	,
1355114	,
1355200	,
1355214	,
1355215	,
1355215	,
1355215	,
1355240	,
1355286	,
1355339	,
1355419	,
1355423	,
1355472	,
1355519	,
1355535	,
1355535	,
1355551	,
1355598	,
1355628	,
1355628	,
1355653	,
1355901	,
1356276	,
1356281	,
1356419	,
1356469	,
1356570	,
1356645	,
1356660	,
1356664	,
1356722	,
1356754	,
1356832	,
1357081	,
1357172	,
1357249	,
1357619	,
1357636	,
1357700	,
1357942	,
1358221	,
1358257	,
1358294	,
1358372	,
1358608	,
1358639	,
1358791	,
1358823	,
1358852	,
1358911	,
1358970	,
1358998	,
1359059	,
1359140	,
1359190	,
1359277	,
1359327	,
1359379	,
1359408	,
1359430	,
1359488	,
1359519	,
1359524	,
1359669	,
1359669	,
1359669	,
1359724	,
1359890	,
1359940	,
1359959	,
1359979	,
1359985	,
1360577	,
1360577	,
1360577	,
1360592	,
1360808	,
1360905	,
1360937	,
1360980	,
1361020	,
1361035	,
1361139	,
1361224	,
1361225	,
1361402	,
1361559	,
1361581	,
1361645	,
1361677	,
1361749	,
1361762	,
1361826	,
1361875	,
1361977	,
1362053	,
1362071	,
1362097	,
1362129	,
1362232	,
1362247	,
1362352	,
1362515	,
1362724	,
1362810	,
1363056	,
1363072	,
1363155	,
1363373	,
1363670	,
1363760	,
1363828	,
1363923	,
1364135	,
1364142	,
1364258	,
1364283	,
1364293	,
1364386	,
1364433	,
1364497	,
1364497	,
1364522	,
1364595	,
1364607	,
1364642	,
1364656	,
1364666	,
1364741	,
1364792	,
1364803	,
1364857	,
1364880	,
1364886	,
1364957	,
1364968	,
1365001	,
1365008	,
1365104	,
1365147	,
1365147	,
1365147	,
1365379	,
1365412	,
1365421	,
1365433	,
1365465	,
1365552	,
1365994	,
1366057	,
1366091	,
1366091	,
1366240	,
1366258	,
1366336	,
1366377	,
1366434	,
1366457	,
1366465	,
1366521	,
1366546	,
1366587	,
1366676	,
1366678	,
1366866	,
1366930	,
1366946	,
1367024	,
1367047	,
1367091	,
1367115	,
1367124	,
1367208	,
1367226	,
1367239	,
1367304	,
1367575	,
1367634	,
1367642	,
1367648	,
1367667	,
1367700	,
1367719	,
1367841	,
1367845	,
1367856	,
1367909	,
1368104	,
1368129	,
1368141	,
1368222	,
1368312	,
1368386	,
1368463	,
1368495	,
1368666	,
1368681	,
1368705	,
1368889	,
1368899	,
1368930	,
1368982	,
1369049	,
1369136	,
1369288	,
1369303	,
1369361	,
1369451	,
1369664	,
1369666	,
1369675	,
1369687	,
1369793	,
1369830	,
1369929	,
1369945	,
1370040	,
1370040	,
1370140	,
1370187	,
1370198	,
1370210	,
1370283	,
1370343	,
1370395	,
1370419	,
1370424	,
1370437	,
1370469	,
1370516	,
1370533	,
1370552	,
1370567	,
1370667	,
1370692	,
1370954	,
1370990	,
1371012	,
1371074	,
1371135	,
1371144	,
1371656	,
1371713	,
1371713	,
1371721	,
1371721	,
1371894	,
1371911	,
1371991	,
1372018	,
1372034	,
1372088	,
1372094	,
1372119	,
1372181	,
1372205	,
1372279	,
1372460	,
1372477	,
1372574	,
1372600	,
1372617	,
1372621	,
1372796	,
1372885	,
1373121	,
1373211	,
1373240	,
1373308	,
1373317	,
1373318	,
1373323	,
1373338	,
1373342	,
1373373	,
1373439	,
1373515	,
1373528	,
1373589	,
1373734	,
1373785	,
1373809	,
1373822	,
1373827	,
1373907	,
1374059	,
1374074	,
1374155	,
1374175	,
1374188	,
1374241	,
1374366	,
1374381	,
1374383	,
1374408	,
1374588	,
1374595	,
1374606	,
1374638	,
1374690	,
1374756	,
1374774	,
1374788	,
1374842	,
1374928	,
1374993	,
1375015	,
1375071	,
1375075	,
1375161	,
1375256	,
1375317	,
1375398	,
1375457	,
1375568	,
1375635	,
1375657	,
1375754	,
1375754	,
1375774	,
1375912	,
1375996	,
1376108	,
1376132	,
1376137	,
1376182	,
1376225	,
1376264	,
1376272	,
1376409	,
1376564	,
1376687	,
1376798	,
1376874	,
1377408	,
1377409	,
1377413	,
1377413	,
1377453	,
1377453	,
1377511	,
1377667	,
1377710	,
1377731	,
1377779	,
1377791	,
1377841	,
1377980	,
1378163	,
1378181	,
1378214	,
1378280	,
1378314	,
1378326	,
1378489	,
1378557	,
1378590	,
1378666	,
1378732	,
1378736	,
1378827	,
1378917	,
1378935	,
1378942	,
1378945	,
1379020	,
1379039	,
1379141	,
1379315	,
1379448	,
1379495	,
1379544	,
1379546	,
1379703	,
1379773	,
1379785	,
1379814	,
1379876	,
1379962	,
1379983	,
1380072	,
1380105	,
1380147	,
1380150	,
1380300	,
1380300	,
1380316	,
1380497	,
1380508	,
1380511	,
1380541	,
1380650	,
1380718	,
1380753	,
1380797	,
1380812	,
1380888	,
1380928	,
1380939	,
1380988	,
1380990	,
1381015	,
1381049	,
1381092	,
1381123	,
1381173	,
1381196	,
1381371	,
1381394	,
1381492	,
1381514	,
1381876	,
1381947	,
1381962	,
1381999	,
1382296	,
1382299	,
1382326	,
1382385	,
1382422	,
1382534	,
1383126	,
1383173	,
1383173	,
1383177	,
1383314	,
1383321	,
1383354	,
1383474	,
1383515	,
1383536	,
1383648	,
1383973	,
1384021	,
1384076	,
1384128	,
1384131	,
1384177	,
1384177	,
1384299	,
1384367	,
1384401	,
1384423	,
1384450	,
1384485	,
1384549	,
1384932	,
1385054	,
1385103	,
1385133	,
1385315	,
1385363	,
1385482	,
1385525	,
1385560	,
1385596	,
1385598	,
1385605	,
1385618	,
1385636	,
1385703	,
1385809	,
1385810	,
1385898	,
1385939	,
1385942	,
1385971	,
1385974	,
1386105	,
1386129	,
1386129	,
1386153	,
1386298	,
1386350	,
1386382	,
1386407	,
1386478	,
1386531	,
1386554	,
1386555	,
1386571	,
1386603	,
1386623	,
1386659	,
1386775	,
1386787	,
1386861	,
1386939	,
1386970	,
1387022	,
1387044	,
1387071	,
1387120	,
1387150	,
1387253	,
1387283	,
1387301	,
1387314	,
1387343	,
1387343	,
1387466	,
1387477	,
1387501	,
1387529	,
1387740	,
1387798	,
1387855	,
1388006	,
1388148	,
1388178	,
1388238	,
1388278	,
1388351	,
1389010	,
1389093	,
1389100	,
1389133	,
1389161	,
1389319	,
1389369	,
1389434	,
1389521	,
1389521	,
1389643	,
1389656	,
1389879	,
1389932	,
1389962	,
1389979	,
1389979	,
1390062	,
1390184	,
1390225	,
1390229	,
1390259	,
1390507	,
1390560	,
1390667	,
1390685	,
1390746	,
1390848	,
1390866	,
1390915	,
1390918	,
1390972	,
1391308	,
1391375	,
1391388	,
1391426	,
1391447	,
1391535	,
1391646	,
1391660	,
1391737	,
1391741	,
1391780	,
1391784	,
1391946	,
1391995	,
1392104	,
1392123	,
1392142	,
1392155	,
1392247	,
1392317	,
1392323	,
1392399	,
1392400	,
1392468	,
1392531	,
1392630	,
1392762	,
1392804	,
1392886	,
1392913	,
1392913	,
1392916	,
1392965	,
1393081	,
1393105	,
1393154	,
1393199	,
1393199	,
1393255	,
1393359	,
1393390	,
1393411	,
1393519	,
1393609	,
1393616	,
1393727	,
1393735	,
1393756	,
1393824	,
1393886	,
1393984	,
1394014	,
1394060	,
1394162	,
1394240	,
1394279	,
1394328	,
1394355	,
1394371	,
1394928	,
1395120	,
1395152	,
1395281	,
1395352	,
1395398	,
1395491	,
1395629	,
1395725	,
1395730	,
1395850	,
1395942	,
1396033	,
1396044	,
1396171	,
1396176	,
1396218	,
1396240	,
1396437	,
1396509	,
1396558	,
1396562	,
1396573	,
1396573	,
1396592	,
1396673	,
1396675	,
1396692	,
1396810	,
1396826	,
1396835	,
1396862	,
1396983	,
1397137	,
1397397	,
1397468	,
1397496	,
1397550	,
1397652	,
1397761	,
1397773	,
1397878	,
1397969	,
1398017	,
1398035	,
1398130	,
1398150	,
1398170	,
1398181	,
1398328	,
1398347	,
1398354	,
1398362	,
1398380	,
1398380	,
1398565	,
1398665	,
1398697	,
1398729	,
1398750	,
1398804	,
1398845	,
1398927	,
1398958	,
1398960	,
1399037	,
1399126	,
1399205	,
1399246	,
1399246	,
1399246	,
1399256	,
1399301	,
1399316	,
1399405	,
1399431	,
1399445	,
1399457	,
1399568	,
1399641	,
1399664	,
1399670	,
1399687	,
1399811	,
1399882	,
1399904	,
1400022	,
1400049	,
1400082	,
1400129	,
1400149	,
1400177	,
1400242	,
1400249	,
1400335	,
1400335	,
1400348	,
1400381	,
1400416	,
1400430	,
1400446	,
1400476	,
1401070	,
1401070	,
1401090	,
1401103	,
1401139	,
1401208	,
1401209	,
1401242	,
1401271	,
1401448	,
1401477	,
1401485	,
1401834	,
1401847	,
1401963	,
1401998	,
1402088	,
1402114	,
1402150	,
1402286	,
1402300	,
1402365	,
1402501	,
1402563	,
1402565	,
1402605	,
1402633	,
1402639	,
1402689	,
1402702	,
1402702	,
1402722	,
1402732	,
1402777	,
1402810	,
1402922	,
1402950	,
1402952	,
1402953	,
1402969	,
1402978	,
1402984	,
1403022	,
1403022	,
1403078	,
1403123	,
1403238	,
1403283	,
1403377	,
1403476	,
1403516	,
1403541	,
1403643	,
1403658	,
1403661	,
1403709	,
1403713	,
1403777	,
1403818	,
1403877	,
1403944	,
1403990	,
1404017	,
1404043	,
1404043	,
1404050	,
1404061	,
1404224	,
1404289	,
1404325	,
1404335	,
1404411	,
1404447	,
1404460	,
1404462	,
1404531	,
1404560	,
1404578	,
1404578	,
1404600	,
1404609	,
1404714	,
1404771	,
1404830	,
1404916	,
1404948	,
1404970	,
1405062	,
1405063	,
1405149	,
1405150	,
1405154	,
1405196	,
1405260	,
1405285	,
1405286	,
1405424	,
1405431	,
1405471	,
1405471	,
1405471	,
1405482	,
1405545	,
1405638	,
1405681	,
1405855	,
1405882	,
1405909	,
1405910	,
1405928	,
1405975	,
1406002	,
1406028	,
1406054	,
1406082	,
1406153	,
1406276	,
1406319	,
1406376	,
1406435	,
1406504	,
1406513	,
1406600	,
1406600	,
1406616	,
1406636	,
1406644	,
1406659	,
1406683	,
1406724	,
1406743	,
1407276	,
1407276	,
1407276	,
1407276	,
1407346	,
1407346	,
1407361	,
1407391	,
1407433	,
1407472	,
1407491	,
1407549	,
1407585	,
1407595	,
1407677	,
1407703	,
1407710	,
1407828	,
1407832	,
1407832	,
1408076	,
1408192	,
1408230	,
1408265	,
1408301	,
1408322	,
1408349	,
1408495	,
1408519	,
1408566	,
1408646	,
1408698	,
1408736	,
1408799	,
1408801	,
1408844	,
1408870	,
1408898	,
1408937	,
1408937	,
1408966	,
1409014	,
1409046	,
1409156	,
1409186	,
1409189	,
1409198	,
1409221	,
1409259	,
1409259	,
1409315	,
1409345	,
1409360	,
1409397	,
1409476	,
1409616	,
1409715	,
1409754	,
1409782	,
1409799	,
1409801	,
1409801	,
1409888	,
1409898	,
1409903	,
1409906	,
1409956	,
1410024	,
1410123	,
1410145	,
1410201	,
1410222	,
1410237	,
1410240	,
1410267	,
1410296	,
1410296	,
1410302	,
1410317	,
1410347	,
1410477	,
1410540	,
1410544	,
1410561	,
1410587	,
1410592	,
1410622	,
1410668	,
1410705	,
1410718	,
1410722	,
1410723	,
1410860	,
1410868	,
1410870	,
1410896	,
1410914	,
1410932	,
1410973	,
1411030	,
1411036	,
1411089	,
1411123	,
1411197	,
1411330	,
1411408	,
1411410	,
1411450	,
1411497	,
1411543	,
1411544	,
1411554	,
1411679	,
1411687	,
1411728	,
1411728	,
1411728	,
1411754	,
1411764	,
1411900	,
1411918	,
1411942	,
1411965	,
1412119	,
1412145	,
1412174	,
1412265	,
1412291	,
1412307	,
1412316	,
1412342	,
1412490	,
1412525	,
1412546	,
1412579	,
1412637	,
1412675	,
1412694	,
1412766	,
1412766	,
1412777	,
1412789	,
1412798	,
1412872	,
1412894	,
1412915	,
1412934	,
1412935	,
1412977	)




declare @Fecha_Corte datetime,
	@Fecha_Caracter	varchar(15)

CREATE TABLE #tbCriteriosTmp
		(tbla Char(128),
		 cdgo_cmpo Char(128),
		 oprdr Char(2),
		 vlr Char(250),
		 cmpo_rlcn Char(128) NULL,
		 cmpo_rlcn_prmtro Char(128) NULL,
		 cnsctvo Numeric(4))

insert into #tbCriteriosTmp 
(tbla, cdgo_cmpo, oprdr , vlr, cmpo_rlcn, cmpo_rlcn_prmtro, cnsctvo) 
values 

('#TmpCarteraXEdades', 'fcha_crcn', '<=' ,'2008/01/31', 'fcha_crcn', '',1)       



Select	@Fecha_Caracter	=		 substring(ltrim(rtrim(vlr)),1,4) + 	substring(ltrim(rtrim(vlr)),6,2) + substring(ltrim(rtrim(vlr)),9,2)
From	#tbCriteriosTmp
Where    cdgo_cmpo	=	'fcha_crcn'

Set	@Fecha_Corte	=	convert(datetime,@Fecha_Caracter)




select  a.cnsctvo_estdo_cnta,
	a.nmro_estdo_cnta,
	e.cnsctvo_estdo_cnta_cntrto,
	a.nmro_unco_idntfccn_empldr, 
	a.cnsctvo_scrsl, 
	a.cnsctvo_cdgo_clse_aprtnte ,
	a.Fcha_crcn , 
	e.nmro_cntrto,
	e.cnsctvo_cdgo_tpo_cntrto,
	bdrecaudos.dbo.fnCalculaPeriodo (a.Fcha_crcn) Periodo,
	e.sldo,
	a.sldo_estdo_cnta,
	b.prmtr_crtra_pc	cnsctvo_cdgo_prmtr ,           
	b.sde_crtra_pc     	Cnsctvo_cdgo_sde,
 	0 dfrnca_mra 
into	#tmpEstadosCuenta
from #tmpCastigar a, bdafiliacion..tbsucursalesaportante  b, tbLiquidaciones d, tbestadosCuentaContratos e
--where	 sldo_estdo_cnta		 >	 0
where    e.sldo > 0
And	a.nmro_unco_idntfccn_empldr	=	b.nmro_unco_idntfccn_empldr
And	a.cnsctvo_cdgo_clse_aprtnte	=	b.cnsctvo_cdgo_clse_aprtnte
And	a.cnsctvo_scrsl						=	b.cnsctvo_scrsl
And a.cnsctvo_cdgo_lqdcn			=	d.cnsctvo_cdgo_lqdcn  
And d.cnsctvo_cdgo_estdo_lqdcn	=	3
And a.cnsctvo_estdo_cnta			= 	e.cnsctvo_estdo_cnta 



update  #tmpEstadosCuenta
Set	dfrnca_mra	=	Datediff(Month,Convert(varchar(6), Periodo)+'01',Substring(convert(varchar(8),@Fecha_Corte,112),1,6)+ '01')

delete #tmpEstadosCuenta where dfrnca_mra < 12 


CREATE TABLE dbo.#TMPcontratosresponsableprevio (
	cnsctvo_estdo_cnta 				int NULL ,
	nmro_unco_idntfccn_empldr int NULL ,
	cnsctvo_scrsl 						int NULL ,
	cnsctvo_cdgo_clse_aprtnte int NULL ,
	ttl_fctrdo 								numeric (12, 0) NULL ,
	vlr_iva 									numeric (12, 0) NULL ,
	ttl_pgr 									numeric (12, 0) NULL ,
	nmro_estdo_cnta 					char (15)  NULL ,
	cnsctvo_cdgo_tpo_cntrto 	int NULL ,
	nmro_cntrto 							char (15)  NULL ,
	nmbre_afldo 							char (200)  NULL ,
	nmbre_scrsl 							char (200)  NULL ,
	rzn_scl 									char (200) NULL ,
	dgto_vrfccn 							int NULL ,
	nmro_idntfccn_empldr 			char (20)  NULL ,
	cdgo_tpo_idntfccn_empldr 	char (3) NULL ,
	cnsctvo_cdgo_tpo_idntfccn_Empldr int NULL ,
	cdgo_tpo_idntfccn 				char (3)  NULL ,
	nmro_idntfccn 						char (23)  NULL ,
	accn 											char (15)  NULL ,
	cnsctvo_cdgo_pln 					int NULL ,
	nmro_unco_idntfccn_afldo 	int NULL ,
	cnsctvo_cdgo_estdo_estdo_cnta int NULL ,
	sldo_estdo_cnta numeric (12, 0) NULL ,
	vlr_cbrdo_cntrto numeric (12, 0) NULL ,
	sldo_cntrto numeric (12, 0) NULL ,
	cnsctvo_estdo_cnta_cntrto int NULL ,
)